services:
  pushguardian:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pushguardian
    user: "${UID:-1000}:${GID:-1000}"
    volumes:
      # Monter le projet Ã  valider
      - ./:/workspace
      # Monter la config git
      - ~/.gitconfig:/home/pushguardian/.gitconfig:ro
    working_dir: /workspace
    environment:
      - NODE_ENV=production
      - TOKEN=${TOKEN:-}
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}
      - BITBUCKET_USERNAME=${BITBUCKET_USERNAME:-}
      - BITBUCKET_PASSWORD=${BITBUCKET_PASSWORD:-}
      - AZURE_DEVOPS_URL=${AZURE_DEVOPS_URL:-}
      - AZURE_DEVOPS_TOKEN=${AZURE_DEVOPS_TOKEN:-}
    command: validate

  # Service pour tests
  test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./:/app
      - /app/node_modules
    command: npm test

  # Service pour couverture
  coverage:
    build:
      context: .
      dockerfile: Dockerfile.dev
    volumes:
      - ./:/app
      - /app/node_modules
      - ./coverage:/app/coverage
    command: npm run test:coverage
